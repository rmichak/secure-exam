# Squid Transparent Proxy Configuration for Website Allowlist
# ============================================================

# Standard HTTP proxy port (for explicit proxy config)
http_port 3128

# Transparent/intercept ports
http_port 3129 intercept
https_port 3130 intercept ssl-bump \
    cert=/etc/squid/ssl/squid-ca.pem \
    generate-host-certificates=on \
    dynamic_cert_mem_cache_size=4MB

# SSL Bump - peek at SNI to filter HTTPS by domain without full MITM
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3

# Peek at the SNI, then splice (pass through) or terminate
ssl_bump peek step1 all
ssl_bump stare step2 all
ssl_bump bump step3 all

# Access control lists
acl localnet src 10.0.0.0/8
acl localnet src 172.16.0.0/12
acl localnet src 192.168.0.0/16
acl localnet src 127.0.0.0/8

# Safe ports
acl SSL_ports port 443
acl Safe_ports port 80
acl Safe_ports port 443
acl CONNECT method CONNECT

# Load allowlist from generated domains file
acl allowed_domains dstdomain "/etc/squid/allowlist-domains.txt"

# Deny requests to unsafe ports
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports

# Allow localhost
http_access allow localhost

# Allow only whitelisted domains
http_access allow allowed_domains

# Deny everything else
http_access deny all

# Custom error page for blocked sites
deny_info ERR_BLOCKED_SITE all

# Error page directory
error_directory /etc/squid/errors

# Logging
access_log /var/log/squid/access.log squid
cache_log /var/log/squid/cache.log

# Cache settings
cache_mem 64 MB
maximum_object_size_in_memory 512 KB
cache_dir ufs /var/spool/squid 100 16 256

# Use local dnsmasq for DNS
dns_nameservers 127.0.0.1

# Visible hostname in error pages
visible_hostname exam-proxy

# Quick shutdown
shutdown_lifetime 3 seconds

# Don't upgrade HTTP requests
upgrade_proto_to_http disabled
