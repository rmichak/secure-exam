<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Secure Exam Desktop</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      color: white;
      padding: 20px;
    }

    .container { max-width: 1200px; margin: 0 auto; }

    h1 {
      margin-bottom: 30px;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #00d4ff, #0099cc);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .section {
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .section h2 {
      margin-bottom: 15px;
      font-size: 18px;
      color: #00d4ff;
    }

    .images-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }

    .image-card {
      background: rgba(255,255,255,0.95);
      border-radius: 8px;
      padding: 20px;
      color: #333;
    }

    .image-card h3 { margin-bottom: 8px; }

    .image-card p {
      font-size: 14px;
      color: #666;
      margin-bottom: 15px;
    }

    .btn {
      background: linear-gradient(135deg, #00d4ff, #0099cc);
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }

    .btn:hover { opacity: 0.9; }
    .btn-danger { background: #e74c3c; }
    .btn-secondary { background: #666; }

    .sessions-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .session-item {
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      padding: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .session-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #00ff88;
    }

    .status-dot.stopped { background: #e74c3c; }
    .status-dot.starting {
      background: #f39c12;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .status-text {
      font-size: 11px;
      color: #f39c12;
      margin-top: 2px;
    }

    .session-actions {
      display: flex;
      gap: 10px;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #888;
    }

    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .modal.active { display: flex; }

    .modal-content {
      background: #1a1a2e;
      border-radius: 12px;
      padding: 30px;
      max-width: 400px;
      width: 90%;
    }

    .modal h3 { margin-bottom: 20px; }

    .form-group { margin-bottom: 15px; }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
    }

    .form-group input {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #333;
      background: #0a0a15;
      color: white;
      font-size: 14px;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>
      <div class="logo">S</div>
      Secure Exam Desktop
    </h1>

    <div class="section">
      <h2>Available Images</h2>
      <div class="images-grid" id="imagesGrid"></div>
    </div>

    <div class="section">
      <h2>Running Sessions</h2>
      <div class="sessions-list" id="sessionsList"></div>
    </div>
  </div>

  <div class="modal" id="launchModal">
    <div class="modal-content">
      <h3>Launch Desktop</h3>
      <div class="form-group">
        <label>Session Name</label>
        <input type="text" id="sessionName" placeholder="e.g., student-1">
      </div>
      <input type="hidden" id="selectedImage">
      <div class="modal-actions">
        <button class="btn" id="confirmLaunchBtn">Launch</button>
        <button class="btn btn-secondary" id="cancelModalBtn">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    var API_BASE = '';
    var startingSessions = {}; // Track sessions that are starting up

    function createElement(tag, className, textContent) {
      var el = document.createElement(tag);
      if (className) el.className = className;
      if (textContent) el.textContent = textContent;
      return el;
    }

    function createButton(className, text, onClick) {
      var btn = createElement('button', className, text);
      btn.addEventListener('click', onClick);
      return btn;
    }

    function loadImages() {
      fetch(API_BASE + '/api/images')
        .then(function(res) { return res.json(); })
        .then(function(images) {
          var grid = document.getElementById('imagesGrid');
          while (grid.firstChild) grid.removeChild(grid.firstChild);

          images.forEach(function(img) {
            var card = createElement('div', 'image-card');
            var title = createElement('h3', null, img.name);
            var desc = createElement('p', null, img.description);
            var btn = createButton('btn', 'Launch', function() {
              showLaunchModal(img.id);
            });
            card.appendChild(title);
            card.appendChild(desc);
            card.appendChild(btn);
            grid.appendChild(card);
          });
        });
    }

    function loadSessions() {
      fetch(API_BASE + '/api/sessions')
        .then(function(res) { return res.json(); })
        .then(function(sessions) {
          var list = document.getElementById('sessionsList');
          while (list.firstChild) list.removeChild(list.firstChild);

          if (sessions.length === 0) {
            var empty = createElement('div', 'empty-state', 'No running sessions');
            list.appendChild(empty);
            return;
          }

          sessions.forEach(function(s) {
            var item = createElement('div', 'session-item');
            var info = createElement('div', 'session-info');
            var isStarting = startingSessions[s.id];
            var dotClass = 'status-dot';
            if (isStarting) {
              dotClass += ' starting';
            } else if (s.status !== 'running') {
              dotClass += ' stopped';
            }
            var dot = createElement('div', dotClass);
            var details = createElement('div');
            var name = createElement('strong', null, s.id);
            var imageName = createElement('div', null, s.imageName);
            imageName.style.fontSize = '12px';
            imageName.style.color = '#888';
            details.appendChild(name);
            details.appendChild(imageName);
            if (isStarting) {
              var statusText = createElement('div', 'status-text', 'Starting... (' + isStarting + 's)');
              details.appendChild(statusText);
            }
            info.appendChild(dot);
            info.appendChild(details);

            var actions = createElement('div', 'session-actions');
            var connectBtn = createButton('btn', 'Connect', function() {
              connect(s.id);
            });
            if (isStarting) {
              connectBtn.disabled = true;
            }
            var terminateBtn = createButton('btn btn-danger', 'Terminate', function() {
              terminate(s.id);
            });
            actions.appendChild(connectBtn);
            actions.appendChild(terminateBtn);

            item.appendChild(info);
            item.appendChild(actions);
            list.appendChild(item);
          });
        });
    }

    function showLaunchModal(imageId) {
      document.getElementById('selectedImage').value = imageId;
      document.getElementById('sessionName').value = '';
      document.getElementById('launchModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('launchModal').classList.remove('active');
    }

    function pollUntilReady(sessionId, maxAttempts) {
      maxAttempts = maxAttempts || 60; // Default 60 seconds max
      var attempts = 0;

      function poll() {
        attempts++;
        startingSessions[sessionId] = attempts;
        loadSessions(); // Refresh UI to show elapsed time

        fetch(API_BASE + '/api/sessions/' + sessionId + '/status')
          .then(function(res) { return res.json(); })
          .then(function(data) {
            if (data.status === 'ready') {
              delete startingSessions[sessionId];
              loadSessions();
              connect(sessionId);
            } else if (attempts < maxAttempts) {
              setTimeout(poll, 1000);
            } else {
              delete startingSessions[sessionId];
              loadSessions();
              alert('Session took too long to start. Try connecting manually.');
            }
          })
          .catch(function(err) {
            if (attempts < maxAttempts) {
              setTimeout(poll, 1000);
            } else {
              delete startingSessions[sessionId];
              loadSessions();
            }
          });
      }

      poll();
    }

    function confirmLaunch() {
      var imageId = document.getElementById('selectedImage').value;
      var sessionName = document.getElementById('sessionName').value;

      fetch(API_BASE + '/api/sessions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ imageId: imageId, sessionName: sessionName })
      })
        .then(function(res) { return res.json(); })
        .then(function(data) {
          if (data.error) {
            alert('Failed to launch: ' + data.error);
            return;
          }
          closeModal();
          startingSessions[data.id] = 0;
          loadSessions();
          pollUntilReady(data.id);
        });
    }

    function connect(sessionId) {
      // Path-based routing through port 80 gateway
      // autoconnect=true and password=student for automatic connection
      // path parameter tells noVNC where to find the WebSocket endpoint
      var wsPath = 'vnc/' + sessionId + '/websockify';
      window.open('/vnc/' + sessionId + '/vnc.html?autoconnect=true&password=student&path=' + wsPath, '_blank');
    }

    function terminate(sessionId) {
      if (!confirm('Terminate this session?')) return;

      fetch(API_BASE + '/api/sessions/' + sessionId, {
        method: 'DELETE'
      })
        .then(function(res) { return res.json(); })
        .then(function(data) {
          if (data.error) {
            alert('Failed to terminate: ' + data.error);
          }
          loadSessions();
        })
        .catch(function(err) {
          alert('Error: ' + err.message);
          loadSessions();
        });
    }

    document.getElementById('confirmLaunchBtn').addEventListener('click', confirmLaunch);
    document.getElementById('cancelModalBtn').addEventListener('click', closeModal);

    loadImages();
    loadSessions();
    setInterval(loadSessions, 5000);
  </script>
</body>
</html>
